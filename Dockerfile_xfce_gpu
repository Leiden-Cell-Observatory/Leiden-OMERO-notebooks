FROM ghcr.io/prefix-dev/pixi:0.53.0-noble-cuda-12.8.1
#FROM ghcr.io/prefix-dev/pixi:latest
USER root

# Install XFCE desktop and VNC server (based on jupyter-remote-desktop-proxy requirements)
RUN apt-get clean && apt-get update && \
    apt-get install -y --no-install-recommends \
    dbus-x11 \
    xclip \
    xfce4 \
    xfce4-panel \
    xfce4-session \
    xfce4-settings \
    xorg \
    xubuntu-icon-theme \
    fonts-dejavu \
    tigervnc-standalone-server \
    build-essential \
    git \
    mesa-utils \
    libglx-mesa0 \
    libegl1 \
    libdbus-1-3 \
    libxkbcommon-x11-0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xfixes0 \
    x11-utils \
    libxcb-cursor0 \
    libopengl0 \
    libfontconfig1 \
    libxrender1 \
    libxi6 \
    libxcb-shape0 \
    libglib2.0-0 \
    # Additional dependencies for micro_sam and image processing
    libsm6 \
    libxext6 \
    libgeos-dev \
    libgl1-mesa-dev \
    libx11-6 \
    libxcb1 \
    libxau6 \
    libxdmcp6 \
    libxfixes3 \
    libxcb-shm0 \
    libxcb-render0 \
    libxcb-xkb1 \
    && apt-get remove -y xfce4-screensaver \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create ubuntu user directories and set permissions
RUN mkdir -p /home/ubuntu && chown -R ubuntu:ubuntu /home/ubuntu

USER ubuntu
WORKDIR /home/ubuntu

# Set up environment variables
ENV MICROSAM_CACHEDIR=/home/ubuntu/microsam_cache
ENV CELLPOSE_LOCAL_MODELS_PATH=/home/ubuntu/cellpose_models
ENV PIXI_CACHE_DIR=/home/ubuntu/.pixi/cache

RUN mkdir -p ${MICROSAM_CACHEDIR} ${CELLPOSE_LOCAL_MODELS_PATH} ${PIXI_CACHE_DIR}

# Install pixi environments with jupyter-remote-desktop-proxy
COPY pixi.toml .
COPY pixi.lock .
RUN pixi install --all

EXPOSE 8888

# Start Jupyter Lab
CMD ["pixi", "run", "jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]