FROM ghcr.io/prefix-dev/pixi:0.49.0-noble-cuda-12.8.1

USER root

# Install comprehensive graphics and Xpra components
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    # Qt/Graphics libraries
    mesa-utils \
    libglx-mesa0 \
    libegl1 \
    libdbus-1-3 \
    libxkbcommon-x11-0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xfixes0 \
    libxcb-cursor0 \
    libopengl0 \
    libfontconfig1 \
    libxrender1 \
    libxi6 \
    libxcb-shape0 \
    x11-utils \
    # Xpra dependencies
    wget \
    gnupg2 \
    apt-transport-https \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Xpra from official repo (for Ubuntu 24.04 Noble)
RUN wget -O "/usr/share/keyrings/xpra.asc" https://xpra.org/xpra.asc && \
    echo "deb [signed-by=/usr/share/keyrings/xpra.asc] https://xpra.org/ noble main" > /etc/apt/sources.list.d/xpra.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    xpra \
    xpra-x11 \
    xvfb \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create runtime directory for XDG
RUN mkdir -p /run/user/1000 && chown ubuntu:ubuntu /run/user/1000

USER ubuntu
WORKDIR /home/ubuntu

# Set proper environment variables
ENV DISPLAY=:100
ENV XDG_RUNTIME_DIR=/run/user/1000
ENV QT_QPA_PLATFORM=xcb
ENV MICROSAM_CACHEDIR=/home/ubuntu/microsam_cache
ENV CELLPOSE_LOCAL_MODELS_PATH=/home/ubuntu/cellpose_models
ENV PIXI_CACHE_DIR=/home/ubuntu/.pixi/cache

RUN mkdir -p ${MICROSAM_CACHEDIR} ${CELLPOSE_LOCAL_MODELS_PATH} ${PIXI_CACHE_DIR}

# Install pixi environments
COPY pixi.toml .
COPY pixi.lock .
RUN pixi install --all

EXPOSE 8888 9876

CMD ["pixi", "run", "jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]FROM ghcr.io/prefix-dev/pixi:0.49.0-noble-cuda-12.8.1

USER root

# Install comprehensive graphics and Xpra components
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    # Qt/Graphics libraries
    mesa-utils \
    libglx-mesa0 \
    libegl1 \
    libdbus-1-3 \
    libxkbcommon-x11-0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xfixes0 \
    libxcb-cursor0 \
    libopengl0 \
    libfontconfig1 \
    libxrender1 \
    libxi6 \
    libxcb-shape0 \
    x11-utils \
    # Xpra dependencies
    wget \
    gnupg2 \
    apt-transport-https \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Xpra from official repo (for Ubuntu 24.04 Noble)
RUN wget -O "/usr/share/keyrings/xpra.asc" https://xpra.org/xpra.asc && \
    echo "deb [signed-by=/usr/share/keyrings/xpra.asc] https://xpra.org/ noble main" > /etc/apt/sources.list.d/xpra.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    xpra \
    xpra-x11 \
    xvfb \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create runtime directory for XDG
RUN mkdir -p /run/user/1000 && chown ubuntu:ubuntu /run/user/1000

USER ubuntu
WORKDIR /home/ubuntu

# Set proper environment variables
ENV DISPLAY=:100
ENV XDG_RUNTIME_DIR=/run/user/1000
ENV QT_QPA_PLATFORM=xcb
ENV MICROSAM_CACHEDIR=/home/ubuntu/microsam_cache
ENV CELLPOSE_LOCAL_MODELS_PATH=/home/ubuntu/cellpose_models
ENV PIXI_CACHE_DIR=/home/ubuntu/.pixi/cache

RUN mkdir -p ${MICROSAM_CACHEDIR} ${CELLPOSE_LOCAL_MODELS_PATH} ${PIXI_CACHE_DIR}

# Install pixi environments
COPY pixi.toml .
COPY pixi.lock .
RUN pixi install --all

EXPOSE 8888 9876

CMD ["pixi", "run", "jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]