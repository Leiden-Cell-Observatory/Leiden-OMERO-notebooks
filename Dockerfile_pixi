# Use the Pixi base image with CUDA support
FROM ghcr.io/prefix-dev/pixi:0.49.0-noble-cuda-12.8.1

USER root

# Install system dependencies required for XFCE, VNC, and core image processing libraries
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    libgeos-dev \
    libgl1-mesa-dev \
    build-essential \
    # X11 client libraries needed for GUI applications
    libx11-6 \
    libxcb1 \
    libxau6 \
    libxdmcp6 \
    libxfixes3 \
    libxcb-shm0 \
    libxcb-render0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-xinerama0 \
    libxcb-xkb1 \
    libxkbcommon-x11-0 \
    libxcb-cursor0 \
    # XFCE desktop environment
    xfce4 \
    xfce4-goodies \
    # VNC server and related tools
    tigervnc-standalone-server \
    websockify \
    novnc \
    sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set environment variable to cache micro_sam models (optional, can be moved to pixi config)
ENV MICROSAM_CACHEDIR=/home/jovyan/microsam_cache
RUN mkdir -p ${MICROSAM_CACHEDIR} && chown -R jovyan:users ${MICROSAM_CACHEDIR}

# Set environment variable for cellpose models directory (optional, can be moved to pixi config)
ENV CELLPOSE_LOCAL_MODELS_PATH=/home/jovyan/cellpose_models
RUN mkdir -p ${CELLPOSE_LOCAL_MODELS_PATH}

USER jovyan

WORKDIR /home/jovyan

# Copy the pixi.toml file to the working directory
COPY pixi.toml .

# Install dependencies using Pixi
# This will create the .pixi environment and install all declared packages.
RUN pixi install

# --- Special handling for packages that are only available as a wheel or non-standard install ---
# The zeroc_ice wheel:
# If this *exact* wheel is not available via conda-forge or PyPI in the usual way,
# you might need to install it separately.
# Pixi's `pypi-dependencies` can sometimes handle URLs, but for very specific
# local wheel paths, a direct `pip install` might still be needed in a pixi task.
# For simplicity and robustness, if `pixi install` doesn't pick it up from `pypi-dependencies`,
# you could add a pixi task to run this specific pip install.
# For example, in pixi.toml:
# [tasks.install-zeroc-ice]
# cmd = "python -m pip install https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/download/20240202/zeroc_ice-3.6.5-cp312-cp312-manylinux_2_28_x86_64.whl"
# And then in Dockerfile: `RUN pixi run install-zeroc-ice`
# However, usually, pixi's PyPI integration is quite good. Let's assume it handles it via `pypi-dependencies` if needed.

# --- XFCE and VNC Configuration (remains largely the same) ---

# Set VNC password and display number
ENV VNC_PW=your_vnc_password_here # IMPORTANT: Change this password!
ENV DISPLAY=:1

# Copy startup script for VNC and XFCE
COPY start_xfce_vnc.sh /usr/local/bin/start_xfce_vnc.sh
RUN chmod +x /usr/local/bin/start_xfce_vnc.sh

# Configure jupyter-server-proxy for noVNC
RUN mkdir -p /home/jovyan/.jupyter/lab/static/proxy_apps && \
    echo '{"title": "XFCE Desktop", "launcher_entry": {"enabled": true}, "display_url": "/proxy/vnc/", "new_tab": true}' > /home/jovyan/.jupyter/lab/static/proxy_apps/xfce.json

# Modify the jupyter_server_config.py to use pixi run for the VNC startup script
# This tells jupyter-server-proxy to use the pixi environment when launching start_xfce_vnc.sh
# IMPORTANT: This assumes your `start_xfce_vnc.sh` will eventually run commands
# that need the pixi environment (like python scripts, or other tools).
# If `start_xfce_vnc.sh` only calls system binaries (like vncserver, websockify),
# then `pixi run` for this particular command might not be strictly necessary,
# but it's good practice for consistency.
RUN echo "c.ServerProxy.servers = {'vnc': {'command': ['pixi', 'run', '/usr/local/bin/start_xfce_vnc.sh'], 'port': 6080, 'timeout': 60}}" >> /etc/jupyter/jupyter_server_config.py

# The base image's CMD already handles starting Jupyter Lab
# EXPOSE 8888
# CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser"]