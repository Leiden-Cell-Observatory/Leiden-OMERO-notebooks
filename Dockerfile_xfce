#FROM ghcr.io/prefix-dev/pixi:0.53.0-noble-cuda-12.8.1
FROM ghcr.io/prefix-dev/pixi:latest
USER root

# Install XFCE desktop and VNC server (based on jupyter-remote-desktop-proxy requirements)
RUN apt-get clean && apt-get update && \
    apt-get install -y --no-install-recommends \
    dbus-x11 \
    xclip \
    xfce4 \
    xfce4-panel \
    xfce4-session \
    xfce4-settings \
    xorg \
    xubuntu-icon-theme \
    fonts-dejavu \
    tigervnc-standalone-server \
    && apt-get remove -y xfce4-screensaver \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create ubuntu user directories and set permissions
RUN mkdir -p /home/ubuntu && chown -R ubuntu:ubuntu /home/ubuntu

USER ubuntu
WORKDIR /home/ubuntu

# Set up environment variables
ENV MICROSAM_CACHEDIR=/home/ubuntu/microsam_cache
ENV CELLPOSE_LOCAL_MODELS_PATH=/home/ubuntu/cellpose_models
ENV PIXI_CACHE_DIR=/home/ubuntu/.pixi/cache

RUN mkdir -p ${MICROSAM_CACHEDIR} ${CELLPOSE_LOCAL_MODELS_PATH} ${PIXI_CACHE_DIR}

# Install pixi environments with jupyter-remote-desktop-proxy
COPY pixi.toml .
COPY pixi.lock .
RUN pixi install --all

EXPOSE 8888

# Start Jupyter Lab
CMD ["pixi", "run", "jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]